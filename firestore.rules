rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isAcceptedAdminOfMachine(ownerUid, machineId) {
      return isSignedIn()
        && request.auth.token.email is string
        && exists(/databases/$(database)/documents/admin_machine_links/$(ownerUid + "_" + machineId + "_" + lower(request.auth.token.email)))
        && get(/databases/$(database)/documents/admin_machine_links/$(ownerUid + "_" + machineId + "_" + lower(request.auth.token.email))).data.adminUid == request.auth.uid
        && get(/databases/$(database)/documents/admin_machine_links/$(ownerUid + "_" + machineId + "_" + lower(request.auth.token.email))).data.status == "accepted";
    }

    match /registration_codes/{code} {
      allow get: if true;
      allow list: if false;
      allow write: if false;
    }

    match /users/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;

      allow create, update: if isSignedIn()
                            && request.auth.uid == uid
                            && request.resource.data.regCode is string
                            && exists(/databases/$(database)/documents/registration_codes/$(request.resource.data.regCode))
                            && get(/databases/$(database)/documents/registration_codes/$(request.resource.data.regCode)).data.active == true;

      allow delete: if false;
    }

    match /tags/{tagId} {
      allow get, list: if isSignedIn();

      allow create, update: if isSignedIn()
        && (
          (resource == null || resource.data.tenantId == null || resource.data.tenantId == "")
            ? request.resource.data.tenantId == request.auth.uid
            : resource.data.tenantId == request.auth.uid
        );

      allow delete: if false;
    }

    match /tenants/{tenantId} {
      allow read: if isOwner(tenantId);
      allow write: if false;

      match /{document=**} {
        allow read: if isOwner(tenantId);
        allow write: if false;
      }
    }

    match /account_directory/{emailLower} {
      allow get: if isSignedIn();
      allow list: if false;

      allow create, update: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.email is string
        && lower(request.resource.data.email) == emailLower;

      allow delete: if false;
    }

    match /admin_machine_links/{linkId} {
      function ownerSide() {
        return isSignedIn()
          && resource != null
          && resource.data.ownerUid == request.auth.uid;
      }

      function adminSide() {
        return isSignedIn()
          && resource != null
          && resource.data.adminUid == request.auth.uid;
      }

      function adminEmailSide() {
        return isSignedIn()
          && resource != null
          && request.auth.token.email != null
          && (
            (resource.data.adminEmailLower is string
              && lower(request.auth.token.email) == resource.data.adminEmailLower)
            ||
            (resource.data.adminEmail is string
              && lower(request.auth.token.email) == lower(resource.data.adminEmail))
          );
      }

      allow get: if (resource != null) && (ownerSide() || adminSide() || adminEmailSide());
      allow list: if isSignedIn();

      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.machineId is string
        && request.resource.data.status == "pending"
        && request.resource.data.adminEmail is string;

      allow update: if isSignedIn()
        && (
          // Admin responde: pending -> accepted/rejected
          (
            resource.data.status == "pending"
            && request.resource.data.status in ["accepted", "rejected"]
            && (
              resource.data.adminUid == request.auth.uid
              ||
              (
                (resource.data.adminUid == null || resource.data.adminUid == "")
                && adminEmailSide()
                && request.resource.data.adminUid == request.auth.uid
              )
            )
          )
          ||
          // Admin deja de administrar: accepted -> left
          (resource.data.adminUid == request.auth.uid
            && resource.data.status == "accepted"
            && request.resource.data.status == "left"
          )
          ||
          // Owner puede actualizar el doc (p.ej. reflejar estado/limpiar)
          (resource.data.ownerUid == request.auth.uid)
        );

      allow delete: if false;
    }

    match /machines/{machineId} {
      allow read: if isSignedIn()
        && resource.data.ownerUid is string
        && (resource.data.ownerUid == request.auth.uid
          || isAcceptedAdminOfMachine(resource.data.ownerUid, machineId));
      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid;
      allow update: if isSignedIn()
        && resource.data.ownerUid is string
        && (resource.data.ownerUid == request.auth.uid
          || isAcceptedAdminOfMachine(resource.data.ownerUid, machineId));
      allow delete: if isSignedIn()
        && resource.data.ownerUid == request.auth.uid;
    }

    match /usernames/{docId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn()
        && request.resource.data.ownerUid is string
        && request.resource.data.machineId is string
        && (request.resource.data.ownerUid == request.auth.uid
          || isAcceptedAdminOfMachine(request.resource.data.ownerUid, request.resource.data.machineId));
      allow delete: if isSignedIn()
        && resource.data.ownerUid is string
        && (resource.data.ownerUid == request.auth.uid
          || isAcceptedAdminOfMachine(resource.data.ownerUid, resource.data.machineId));
    }

    match /machine_access/{tagId} {
      allow get: if true;
      allow list: if false;

      function isOperationalUpdate() {
        return request.auth == null
          && request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(["status", "logs", "tasks", "updatedAt", "updatedBy"])

          && request.resource.data.tenantId == resource.data.tenantId
          && request.resource.data.machineId == resource.data.machineId
          && request.resource.data.users == resource.data.users

          && request.resource.data.title == resource.data.title
          && request.resource.data.brand == resource.data.brand
          && request.resource.data.model == resource.data.model
          && request.resource.data.year == resource.data.year

          && request.resource.data.status is string
          && request.resource.data.logs is list
          && request.resource.data.tasks is list
          && request.resource.data.updatedBy is string

          && (request.resource.data.status in ["operativa", "fuera_de_servicio"]);
      }

      function canManageMachineAccess(tenantId, machineId) {
        return isSignedIn()
          && (request.auth.uid == tenantId || isAcceptedAdminOfMachine(tenantId, machineId));
      }

      allow create: if canManageMachineAccess(request.resource.data.tenantId, request.resource.data.machineId);
      allow update: if canManageMachineAccess(resource.data.tenantId, resource.data.machineId);
      allow delete: if isSignedIn() && resource.data.tenantId == request.auth.uid;

      allow update: if isOperationalUpdate();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
